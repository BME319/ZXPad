<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="user-scalable=no, initial-scale=1.4, maximum-scale=2, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="stylesheet" href="css/jquery.mobile-1.4.2.css" />
<link href="css/timeLine.css" rel="stylesheet" type="text/css" />
<link href="css/target discussion.css" rel="stylesheet" type="text/css" />
<style type="text/css">
/*checkbox样式*/




</style>
</head>

<body>
<div data-role="page" id="ClinicInfoPage">
  <div data-role="header" data-position="fixed" data-theme="a" data-tap-toggle="false"> 
    <a href="javascript: location.href='HomePage.html?';" data-icon="home" data-iconpos="notext" data-shadow="false" data-iconshadow="false">主页</a>
    <h1>创建计划</h1>
    
    <!--navbar -->
    <div data-role="navbar" >
      <ul>
        <li>
          <button class="ui-btn-active ui-state-persist">就诊信息</button>
        </li>
        <li>
          <button>目标讨论</button>
        </li>
        <li>
          <button>任务选择</button>
        </li>
        <li>
          <button>开始计划</button>
        </li>
      </ul>
    </div>
  </div>
  <div data-role="content" data-theme="a">
    <div id="ClinicInfoContent" >
      <input id="AdmissionDateMark" name="AdmissionDateMark" type="hidden" value="1897-01-01 00:00:00" />
      <input id="ClinicDateMark" name="ClinicDateMark" type="hidden" value="1897-01-01 00:00:00" />
      <div id="norecord" style="display: none; margin-top: 20px;margin-bottom:40px;" align="center">
        <p style="font-size: 20px; color: Red;">还没有任何临床信息</p>
      </div>
      <div class="demo" id="demo" style="display: block;">
        <div class="history">
          <div class="history-date">
            <ul id="historyUl">
            </ul>
          </div>
        </div>
        <div id="history_loading" style="display: none; margin-top:0px" align="center"> <img alt="Load" src="img/history_loading.gif" style="width:50px;height:50px;" />
          <p>加载中，请稍后</p>
        </div>
        <div class="white" style="height: 10px; margin-top: 10px;"> </div>
        <!--<div id="historyButton">
                    <input type="button" style="width:800px;height:40px;" class="btn btn-primary" onclick="GetMoreClinic();" value="加载更多" />
                </div>--> 
      </div>
    </div>
    <div class="ui-grid-b">
      <div class="ui-block-a"> </div>
      <div class="ui-block-b" style="text-align:center;">
        <button class="ui-btn ui-btn-inline"  onclick="GetMoreClinic();" id="historyButton">加载更多</button>
        <button class="ui-btn ui-btn-inline" onclick="$.mobile.changePage('#SetTargetPage'); $.mobile.loading( 'show', {text: 'loading', textVisible: true, textonly: false,});">下一步</button>
        <!-- InsertCurSbp(); InsertCurDbp();函数合入InsertTarget中。getGoalValue()获取目标血压与当前血压的差值 ZC 20150511--> 
      </div>
      <div class="ui-block-c"> </div>
    </div>
  </div>
  <div data-role="panel" data-position="right" data-position-fixed="true" data-display="push" data-theme="a" id="ClinicInfoDetail-form">
    <div id="detailTitle" align="center">
      <h2 id = "DetailType"></h2>
    </div>
    <table cellpadding="3" style="margin-top:50px">
      <tr>
        <td width="10%" style="border: 0;"> 患者ID: </td>
        <td width="15%" style="border: 0;" id="PatientId"></td>
        <td width="10%" style="border: 0;"> 患者姓名: </td>
        <td id = "UserName" width="12%" style="border: 0;"></td>
        <td width="5%" style="border: 0;"> 日期: </td>
        <td id= "NowDate" width="12%" style="border: 0;"></td>
      </tr>
    </table>
    <table data-role="table" id="table-column-toggle" data-mode="columntoggle" data-column-btn-text="显示\隐藏" class="ui-responsive table-stroke">
      <thead id = "table-column-toggle-thead">
      </thead>
      <tbody id = "table-column-toggle-tbody">
      </tbody>
    </table>
    <br />
    <br />
    <table id="table-ClinicInfoDetailByType" class="dtypetable">
      <thead id = "table-ClinicInfoDetailByType-thead">
      </thead>
      <tbody id = "table-ClinicInfoDetailByType-tbody">
      </tbody>
    </table>
  </div>
</div>
<div data-role="page" id="SetTargetPage">
  <div data-role="header" data-position="fixed" data-theme="a" data-tap-toggle="false"> <a href="javascript: location.href='HomePage.html?';" data-icon="home" data-iconpos="notext" data-shadow="false" data-iconshadow="false">主页</a>
    <h1>创建计划</h1>
    
    <!--navbar -->
    <div data-role="navbar" >
      <ul>
        <li>
          <button>就诊信息</button>
        </li>
        <li>
          <button class="ui-btn-active ui-state-persist">目标讨论</button>
        </li>
        <li>
          <button>任务选择</button>
        </li>
        <li>
          <button>开始计划</button>
        </li>
      </ul>
    </div>
  </div>
  <div data-role="content" data-theme="a" id="MainField">
    <div class="ui-grid-b">
      <div class="ui-block-a">
        <h3 align="center">血压</h3>
        <div class="ui-grid-a">
          <div class="ui-block-a">
            <div  id="chart_SBP_1" style="float:left;margin-left:10px ; width: 150px; height: 300px;"></div>
          </div>
          <div class="ui-block-b">
            <div  id="chart_DBP_1" style="width: 150px; height: 300px;"></div>
          </div>
          <div data-role="fieldcontain" id="test1">
            <label style="width:50%">当前收缩压</label>
            <input  type="text" id="TextInput1" onkeyup="this.value=this.value.replace(/\D/g,'') ;GetDescription();SBPBar($('#TextInput1').val(), $('#TextInput3').val(), SBPlist, chart_SBP_1);Risk() ; javascript:this.value=this.value.replace(/[^\d]/g,'');if(this.value<0){this.value=0;};if(this.value>200){this.value=200;}" onchange="javascript:this.value=this.value.replace(/[^\d]/g,'');if(this.value<0){this.value=0;};if(this.value>200){this.value=200;}" />
            <label style="width:50%">当前舒张压</label>
            </br>
            </br>
            <input type="text" id="TextInput2" onkeyup="this.value=this.value.replace(/\D/g,'') ;DBPBar($('#TextInput2').val(), $('#TextInput4').val(), DBPlist, chart_DBP_1);Risk() ; javascript:this.value=this.value.replace(/[^\d]/g,'');if(this.value<0){this.value=0;};if(this.value>140){this.value=140;}" onchange="javascript:this.value=this.value.replace(/[^\d]/g,'');if(this.value<0){this.value=0;};if(this.value>140){this.value=140;}"/>
            </br>
            </br>
            </br>
            </br>
            </br>
          </div>
        </div>
      </div>
      
      <div class="ui-block-b">
       <div>
        <h3 align="center">高血压等级说明</h3>
        <textarea data-role="none" id="hyperclass" name="" cols="" rows=""  readonly="readonly" ></textarea>
       </div>
        <div data-role="fieldcontain" id="test2">
          <label style="width:50%">目标收缩压</label>
          <input type="text" id="TextInput3" onkeyup="this.value=this.value.replace(/\D/g,'') ;SBPBar($('#TextInput1').val(), $('#TextInput3').val(), SBPlist, chart_SBP_1)  ; javascript:this.value=this.value.replace(/[^\d]/g,'');if(this.value<0){this.value=0;};if(this.value>200){this.value=200;}" onchange="javascript:this.value=this.value.replace(/[^\d]/g,'');if(this.value<0){this.value=0;};if(this.value>200){this.value=200;}"/>
          <label style="width:50%">目标舒张压</label>
          </br>
          </br>
          <input type="text" id="TextInput4" onkeyup="this.value=this.value.replace(/\D/g,'') ;DBPBar($('#TextInput2').val(), $('#TextInput4').val(), DBPlist, chart_DBP_1) ; javascript:this.value=this.value.replace(/[^\d]/g,'');if(this.value<0){this.value=0;};if(this.value>140){this.value=140;}" onchange="javascript:this.value=this.value.replace(/[^\d]/g,'');if(this.value<0){this.value=0;};if(this.value>140){this.value=140;}"/>
          </br>
          </br>
          </br>
          </br>
        </div>
      </div>
      
      <div class="ui-block-c">
        <h3 align="center">风险评估</h3>
        <!--        <div id="chartdiv3" style="width:300px; height:400px;"> </div>
-->
        <div id="chartdiv3" style="width:350px; height:325px;"> </div>
        <button class="ui-btn ui-btn-inline" onclick="$.mobile.changePage('#ClinicInfoPage');$.mobile.loading( 'show', {text: 'loading', textVisible: true, textonly: false,});">上一步</button>
        <button class="ui-btn ui-btn-inline" onclick="if(InsertTarget()) {$.mobile.changePage('#CreatePlanPage');$.mobile.loading( 'show', {text: 'loading', textVisible: true, textonly: false,});}getGoalValue();">下一步</button>
      </div>
      
    </div>
  </div>
</div>
<div data-role="page" id="CreatePlanPage">
  <div data-role="header" data-position="fixed" data-theme="a" data-tap-toggle="false"> <a href="javascript: location.href='HomePage.html?';" data-icon="home" data-iconpos="notext" data-shadow="false" data-iconshadow="false">主页</a>
    <h1>创建计划</h1>
    <!--navbar -->
    <div data-role="navbar" >
      <ul>
        <li>
          <button>就诊信息</button>
        </li>
        <li>
          <button>目标讨论</button>
        </li>
        <li>
          <button class="ui-btn-active ui-state-persist">任务选择</button>
        </li>
        <li>
          <button>开始计划</button>
        </li>
      </ul>
    </div>
  </div>
  
  <!--content -->
  <div data-role="content" data-theme="a">
    <div id="CPPart1">
      <h4 style="color:#4BAACB">生活方式：</h4>
      <table data-role="table" class="ui-responsive table-stroke">
        <thead>
          <tr>
            <th></th>
            <th></th>
            <th>说明</th>
            <th>效果</th>
            <th>副作用</th>
          </tr>
        </thead>
        <tbody id="LifeStyleBody">
          <!--加载“生活方式” -->
        </tbody>
      </table>
      <div class="ui-grid-a">
        <div class="ui-block-a">
          <h4 id="drugTitle" style="color:#4BAACB">药物治疗：</h4>
        </div>
        <div class="ui-block-b" style="text-align: right"> <a href="#popupDrug" data-rel="popup" data-position-to="window" class="ui-btn ui-corner-all ui-btn-inline ui-icon-star ui-btn-icon-left" data-transition="pop" id="drugBtn">医嘱列表</a> </div>
      </div>
      <table data-role="table" class="ui-responsive table-stroke" id="DrugListTable">
        <!--加载“药物治疗” -->
      </table>
      <div id="LastDrugListDiv" style="height: 50px; color:#cb6c4b" > 
        <!--加载“过往药物治疗” --> 
      </div>
    </div>
    <div id="CPPart2">
      <p>生活方式</p>
      <h1 id="lifestyleChanges" style="color:#4BAACB">0mmHg</h1>
      <img src="img/plus.png" style="height: 24px; width: 24px;"/>
      <p>药物治疗</p>
      <h1 id="drugChanges"  style="color:#4BAACB">0mmHg</h1>
      <hr style="width:60%;"/>
      <p>距离目标</p>
      <h1 id="goal" style="color:#cb6c4b">0mmHg</h1>
    </div>
    <div class="ui-grid-b">
      <div class="ui-block-a"> </div>
      <div class="ui-block-b" style="text-align:center;">
        <button class="ui-btn ui-btn-inline" onclick="$.mobile.changePage('#SetTargetPage');$.mobile.loading( 'show', {text: 'loading', textVisible: true, textonly: false,});">上一步</button>
        <button class="ui-btn ui-btn-inline" onclick="setPsTask();startPlanPageInit();$.mobile.loading( 'show', {text: 'loading', textVisible: true, textonly: false,});">下一步</button>
        <!-- startPlanPageInit()开始计划页面初始化 ZC 2015-05-11--> 
      </div>
      <div class="ui-block-c"> </div>
    </div>
    <div data-role="popup" id="popupDrug" data-theme="a" class="ui-corner-all ui-content" data-dismissible="false"> <a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext ui-btn-right">关闭</a>
      <h3 id="popupH3">该患者过往药嘱列表：</h3>
      <div id="popupDrugDiv"> 
        <!-- 药嘱列表--> 
      </div>
      <div class="ui-grid-a" id="divBtn">
        <div class="ui-block-a"><a href="#" data-rel="back" class="ui-btn ui-corner-all ui-btn-a">取 消</a></div>
        <div class="ui-block-b"><a href="#" data-rel="back" class="ui-btn ui-corner-all ui-btn-a" onclick="setPsDrug();">确 定</a></div>
      </div>
    </div>
  </div>
</div>
<div data-role="page" id="StartPlanPage">
  <div data-role="header" data-position="fixed" data-theme="a" data-tap-toggle="false"> <a href="javascript: location.href='HomePage.html?';" data-icon="home" data-iconpos="notext" data-shadow="false" data-iconshadow="false">主页</a>
    <h1>创建计划</h1>
    
    <!--navbar -->
    <div data-role="navbar" >
      <ul>
        <li>
          <button>就诊信息</button>
        </li>
        <li>
          <button>目标讨论</button>
        </li>
        <li>
          <button>任务选择</button>
        </li>
        <li>
          <button class="ui-btn-active ui-state-persist">开始计划</button>
        </li>
      </ul>
    </div>
  </div>
  
  <!--content --> 
  
  <!--<h1 align="center">开始计划</h1>-->
  <div data-role="content" data-theme="a">
    <div class="ui-grid-a">
      <div class="ui-block-a">
        <p align="center"><b>计划目标</b></p>
        <div style="float:left;width:65%">
                <div class="ui-grid-a">

          <div class="ui-block-a">
          <div id="chart_SBP_2" style="float:left;margin-left:10px ; width: 120px; height: 340px;"></div>
          </div>
          <div class="ui-block-b">
          <div id="chart_DBP_2" style="width: 120px; height: 340px;"></div>
          </div>
          </div>
        </div>
        <div style="float:right;width:35%;height:340px;">
          <div style="height:95px;">
            <div style="float:left;width:65%">
              <p align="center">初始收缩压</p>
            </div>
            <div style="float:left;width:25%">
              <p align="center">
                <input name="textarea" type="text" id="OSBP" readonly="true"/>
              </p>
            </div>
          </div>
          <div style="height:95px;">
            <div style="float:left;width:65%">
              <p align="center">目标收缩压</p>
            </div>
            <div style="float:left;width:25%">
              <p align="center">
                <input name="textarea" type="text" id="TSBP" readonly="true"/>
              </p>
            </div>
          </div>
          <div style="height:95px;">
            <div style="float:left;width:65%">
              <p align="center">初始舒张压</p>
            </div>
            <div style="float:left;width:25%">
              <p align="center">
                <input name="textarea" type="text" id="ODBP" readonly="true"/>
              </p>
            </div>
          </div>
          <div style="height:95px;">
            <div style="float:left;width:65%">
              <p align="center">目标舒张压</p>
            </div>
            <div style="float:left;width:25%">
              <p align="center">
                <input name="textarea" type="text" id="TDBP" readonly="true"/>
              </p>
            </div>
          </div>
        </div>
        <div style="float:left;width:33%">
          <p align="center">计划开始时间</p>
          <p align="center">结束日期设置</p>
        </div>
        <div style="float:left;width:33%">
          <p align="center" id="BeginDate"></p>
          <p align="center">
            <input name="textarea" id="EndDate" type="text" onclick="WdatePicker()" readonly="true"/>
          </p>
          <p align="center"; style="color:#FF0000" id="Alert"></p>
        </div>
        <!--      <div style="float:left;width:33%">
        <p align="center">
          <button id= "btnToStart" style="width:100px; height:40px;" onclick="$.mobile.changePage('#CreatePlanPage');$.mobile.loading( 'show', {text: 'loading', textVisible: true, textonly: false,});">返回修改</button>
          <button id= "btnToStart" style="width:100px; height:40px;" onclick="btn1_listener_f()">确认开始</button>
        </p>
      </div>
--> 
      </div>
      <div class="ui-block-b">
        <p align="center"><b>计划任务</b></p>
        <table align="center" class="gridtable" id="PlanShow">
          <thead id="L0">
            <tr>
              <th><div align="center" style="width:80px;">编号</div></th>
              <th><div align="center" style="width:80px;">类型</div></th>
              <th><div align="center" style="width:80px;">任务名</div></th>
              <th><div align="center" style="width:185px;";>说明</div></th>
            </tr>
          </thead>
        </table>
      </div>
    </div>
    <div class="ui-grid-b">
      <div class="ui-block-a"> </div>
      <div class="ui-block-b" style="text-align:center;">
        <button id= "btnToStart"  class="ui-btn ui-btn-inline"  onclick="$.mobile.changePage('#CreatePlanPage');$.mobile.loading( 'show', {text: 'loading', textVisible: true, textonly: false,});">返回修改</button>
        <button id= "btnToStart"  class="ui-btn ui-btn-inline" onclick="btn1_listener_f()">确认开始</button>
        <!--        <button class="ui-btn ui-btn-inline" onclick="$.mobile.changePage('#SetTargetPage');$.mobile.loading( 'show', {text: 'loading', textVisible: true, textonly: false,});">上一步</button>
        <button class="ui-btn ui-btn-inline" onclick="setPsTask();startPlanPageInit();$.mobile.loading( 'show', {text: 'loading', textVisible: true, textonly: false,});">下一步</button>
--> <!-- startPlanPageInit()开始计划页面初始化 ZC 2015-05-11--> 
      </div>
      <div class="ui-block-c"> </div>
    </div>
  </div>
</div>
</body>
<script src="js/jquery-2.1.3.js" type="text/javascript"></script>
<script src="js/jquery.mobile-1.4.2.js" type="text/javascript"></script>
<script src="js/jquery-ui-1.7.2.custom.min.js" type="text/javascript"></script>
<script src="js/amcharts.js" type="text/javascript"></script>
<script src="js/serial.js" type="text/javascript"></script>
<script src="js/jquery.chromatable.js" type="text/javascript"></script>
<script src="js/WdatePicker.js"></script>
<script type="text/javascript" src="js/CommonUtility.js"></script>
<script type="text/javascript" src="js/target discussion.js"></script>
<script type="text/javascript">
//Loading 

  var SBPlist = new Array();
  var DBPlist = new Array();
  var Tasklist = new Array();
  var bpi = 0;
  var lifeChanges = 0;
  var drugChanges = 0;
  var target = 0;
  var toTarget = 0; //距离目标多少mmHg
  var evaluate={};
  /*
//Loading show

$(document).on("pagehide", "#ClinicInfoPage", function(){

console.log("pagehide");
$.mobile.loading( "show", {text: 'loading', textVisible: true, textonly: false});
});
*/

	//Loading hide
$(document).on("pageshow", "#ClinicInfoPage", function(){

console.log("pageshow");
$.mobile.loading( "hide" ); 
});

$(document).on("pageshow", "#SetTargetPage", function(){

$.mobile.loading( "hide" ); 
});


$(document).on("pageshow", "#CreatePlanPage", function(){

$.mobile.loading( "hide" ); 
});

$(document).on("pageshow", "#StartPlanPage", function(){

$.mobile.loading( "hide" ); 
});


  //ClinicInfoPage自运行
  $(document).on("pageinit", "#ClinicInfoPage", function(){

	 /*localStorage.setItem('UserId', 'D003');
	  localStorage.setItem('TerminalName', 'ZC-PC');
	  localStorage.setItem('TerminalIP', '10.12.43.94');
	  localStorage.setItem('DeviceType', 0);
	  //localStorage.setItem('PatientId','PID201501070026');
      localStorage.setItem('PatientId', 'PID201501070003');
      localStorage.setItem('NewPlanNo', 'P0002');
	  localStorage.setItem('PlanNo', 'PLN201504280012');
	  localStorage.setItem('ModuleType', 'M1');
	  localStorage.setItem('PLType', '1');*/
	  
	  $("#PatientId").text(localStorage.getItem('PatientId'));
	  
	  L = GetMoreClinic();
	  if(L > 0){
		  var target = document.getElementById("demo");
		  target.style.display = "block";
		  var target = document.getElementById("norecord");
		  target.style.display = "none";
      }
	  else{
		  var target = document.getElementById("demo");
		  target.style.display = "none";
		  var target = document.getElementById("norecord");
		  target.style.display = "block";
      }
  });
  
  //SetTargetPage自运行
  
  
    //“开始计划”页面初始化 
  function startPlanPageInit(){
	  GetPsTask(localStorage.getItem('NewPlanNo'));
	  GetPsTarget(localStorage.getItem('NewPlanNo'));
	
      GetBPGrades();
	  setTimeout(function(){
		  SBPBar($("#OSBP").val(),$("#TSBP").val(),SBPlist,chart_SBP_2);
		  },200);
	  setTimeout(function(){
		  DBPBar($("#ODBP").val(),$("#TDBP").val(),DBPlist,chart_DBP_2);
		  },200);
  
	  $.ajax({  
		  type: "POST",
		  dataType: "xml",
		  timeout: 30000,  
		  url: 'http://'+ serverIP +'/'+serviceName+'/GetServerTime',
		  async:false,
		  data: {},
		  beforeSend: function(){},
		  success: function(result) {
		  	  $("#BeginDate").html($(result).text().slice(0,10));	    
		  }, 
		  error: function(msg) {alert("Error!");}
	  });	   
  }
  
  function trim(str) {  //删除左右两端的空格
      return str.replace(/(^\s*)|(\s*$)/g, "");
  } 

 //获取患者就诊信息 WF
  function GetMoreClinic() {
	  var length=0;
	  var target = document.getElementById("history_loading");
	  target.style.display = "block";
	  $("#historyButton").hide();

	  var admissionDateMark = document.getElementById("AdmissionDateMark").value;
	  var clinicDateMark = document.getElementById("ClinicDateMark").value;

	  $.ajax({

		  url:  'http://'+serverIP+'/'+serviceName+'/GetClinicalNewMobile',
		  type: "GET",
		  dataType: "json",
		  async: false,
		  data: { UserId: localStorage.getItem('PatientId'), AdmissionDate: admissionDateMark, ClinicDate: clinicDateMark, Num: 10 },
		  success: function (res) {

			  var target = document.getElementById("history_loading");
			  target.style.display = "none";

			  document.getElementById("AdmissionDateMark").value = res.AdmissionDateMark;  
			  document.getElementById("ClinicDateMark").value = res.ClinicDateMark;

				  length=res.History.length;
				  if (res.History.length > 0) {
					  var str = '';
					  for (var i = 0; i < res.History.length; i++) {
						  str += '<li><h3>' + res.History[i].Time + '</h3> <div class="cbp_tmlabel" id="' + res.History[i].Color + '">';
						  str += '<span class="tag-' + res.History[i].Color + '">' + res.History[i].Tag + '</span>  ';
					 
						  for (var j = 0; j < res.History[i].ItemGroup.length; j++) {
							  if ((res.History[i].ItemGroup[j].Type == "入院") || (res.History[i].ItemGroup[j].Type == "出院") || (res.History[i].ItemGroup[j].Type == "门诊") || (res.History[i].ItemGroup[j].Type == "急诊") || (res.History[i].ItemGroup[j].Type == "当前住院中") || (res.History[i].ItemGroup[j].Type == "转科")) {
								  str += ' <p class="Item" id="">' + res.History[i].ItemGroup[j].Time + '<span style="margin-left:20px;">' + res.History[i].ItemGroup[j].Event + '</span></p>';
							  }
							  else {
							  str += '<p><a href="#ClinicInfoDetail-form"  class="Itemhref" id=' + res.History[i].ItemGroup[j].KeyCode +' onclick="OpenClinicInfoDetail(this.id);">' + res.History[i].ItemGroup[j].Time + '&nbsp;&nbsp;' + res.History[i].ItemGroup[j].Event + '</a></p>';
							  }
						  }
						  str += '</li>';
					  }
					  $("#historyUl").append(str);
					  $("#historyButton").show();
				  }
				  

				  else {
					  $("#historyButton").hide();
		
				  }

			  }

	  });

	  return length;
  }

  function OpenClinicInfoDetail(keycode) {

	  var keycode_split=keycode.split("|",3);
	  var Type = keycode_split[0];
	  var VisitId = keycode_split[1];
	  var DateT = keycode_split[2];
	  var TypeStr="类别："
	  document.getElementById("table-column-toggle-tbody").innerHTML="";
	  document.getElementById("table-ClinicInfoDetailByType-thead").innerHTML="";
	  document.getElementById("table-ClinicInfoDetailByType-tbody").innerHTML="";
	  if(Type=="DrugRecord")
	  {
		  TypeStr+="用药信息";
		  document.getElementById("table-column-toggle-thead").innerHTML="<tr><th data-priority='1'>长期医嘱标志</th><th data-priority='2'>药嘱类别</th><th>药嘱内容</th><th data-priority='4'>药品一次使用剂量</th><th data-priority='5'>剂量单位</th><th data-priority='6'>给药途径</th><th data-priority='7'>开始时间</th><th data-priority='8'>结束时间</th><th data-priority='9'>执行频率描述</th></tr>";
			   
	  }
	  else if(Type=="DiagnosisInfo")
	  {
		  TypeStr+="诊断信息";
		  document.getElementById("table-column-toggle-thead").innerHTML="<tr><th data-priority='1'>诊断类型</th><th data-priority='2'>诊断种类</th><th>诊断名称</th><th data-priority='4'>描述</th><th  data-priority='5'>记录时间</th></tr>";
	  }
	  else if(Type=="ExaminationInfo")
	  {
		  TypeStr+="检查信息";
		  document.getElementById("table-column-toggle-thead").innerHTML="<tr><th data-priority='1'>检查类型</th><th data-priority='2'>检查日期</th><th>检查项目名称</th><th data-priority='4'>检查参数</th><th data-priority='5'>检查所见</th><th data-priority='6'>印象</th><th data-priority='7'>建议</th><th data-priority='8'>是否阳性</th><th data-priority='9'>检查结果状态</th><th data-priority='10'>报告日期</th><th data-priority='11'>图像地址</th><th data-priority='12'>具体参数</th></tr>";
	  }
	  else
	  {
		  TypeStr+="化验信息";
		  document.getElementById("table-column-toggle-thead").innerHTML="<tr><th data-priority='1'>化验类型</th><th>化验项目名称</th><th data-priority='6'>化验日期</th><th data-priority='4'>化验结果状态</th><th data-priority='5'>报告日期</th><th data-priority='3'>具体参数</th></tr>";
	  }
	  document.getElementById("DetailType").innerHTML=TypeStr;
	  document.getElementById("NowDate").innerHTML=DateT.substr(0,10);
	  
		  
	  $.ajax({
		  url:  'http://'+serverIP+'/'+serviceName+'/GetPatBasicInfo',
		  type: "GET",
		  dataType: "xml",
		  async: false,
		  data: { UserId: localStorage.getItem('PatientId')},
		  success: function (res) {
			  
				  document.getElementById("UserName").innerHTML=$(res).find('UserName').text();

		  }
	  });
	  
	  
	  $.ajax({
		  url:  'http://'+serverIP+'/'+serviceName+'/GetClinicInfoDetail',
		  type: "GET",
		  dataType: "xml",
		  async: false,
		  data: { UserId: localStorage.getItem('PatientId'), Type: Type, VisitId: VisitId, Date: DateT },
		  success: function (res) {
			  
				  $(res).find('Table1').each(function() {
					  
					  
					  if(Type=="DrugRecord")
					  {
						  
						  var RepeatIndicator=$(this).find("RepeatIndicator").text();
						  var OrderClass=$(this).find("OrderClass").text();
						  var OrderContent=$(this).find("OrderContent").text();
						  var Dosage=$(this).find("Dosage").text();
						  var DosageUnits=$(this).find("DosageUnits").text();
						  var Administration=$(this).find("Administration").text();
						  var StartDateTime=$(this).find("StartDateTime").text();
						  var StopDateTime=$(this).find("StopDateTime").text();
						  var Frequency=$(this).find("Frequency").text();
		  
						  var trcontent="<tr><td>"+RepeatIndicator+"</td><td>"+OrderClass+"</td><td>"+OrderContent+"</td><td>"+Dosage+"</td><td>"+DosageUnits+"</td><td>"+Administration+"</td><td>"+StartDateTime+"</td><td>"+StopDateTime+"</td><td>"+Frequency+"</td></tr>";
					  
						  $("#table-column-toggle-tbody").append(trcontent);
					  }
					  
					  else if(Type=="DiagnosisInfo")
					  {
						  
						  var DiagnosisTypeName=$(this).find("DiagnosisTypeName").text();
						  var TypeName=$(this).find("TypeName").text();
						  var DiagnosisName=$(this).find("DiagnosisName").text();
						  var Description=$(this).find("Description").text();
						  var RecordDateShow=$(this).find("RecordDateShow").text();
						  var trcontent= "<tr><td>"+DiagnosisTypeName+"</td><td>"+TypeName+"</td><td>"+DiagnosisName+"</td><td>"+Description+"</td><td>"+RecordDateShow+"</td></tr>";
						  $("#table-column-toggle-tbody").append(trcontent);
						  
					  }
					  
					  else if(Type=="ExaminationInfo")
					  {
						  var ExamTypeName=$(this).find("ExamTypeName").text();
						  var ExamDate=$(this).find("ExamDate").text();
						  var ItemName=$(this).find("ItemName").text();
						  var ExamPara=$(this).find("ExamPara").text();
						  var Description=$(this).find("Description").text();
						  var Impression=$(this).find("Impression").text();
						  var Recommendation=$(this).find("Recommendation").text();
						  var IsAbnormal=$(this).find("IsAbnormal").text();
						  var Status=$(this).find("Status").text();
						  var ReportDate=$(this).find("ReportDate").text();
						  var ImageURL=$(this).find("ImageURL").text();
						  var SortNo=$(this).find("SortNo").text();
						  var ItemCode=$(this).find("ItemCode").text();
						  
						 var trcontent="<tr><td>"+ExamTypeName+"</td><td>"+ExamDate+"</td><td>"+ItemName+"</td><td>"+ExamPara+"</td><td>"+Description+"</td><td>"+Impression+"</td><td>"+Recommendation+"</td><td>"+IsAbnormal+"</td><td>"+Status+"</td><td>"+ReportDate+"</td><td>"+ImageURL+"</td><td id='ClinicInfoDetailByType-ExaminationInfo'><a id = "+localStorage.getItem('PatientId')+"|"+VisitId+"|"+SortNo+"|"+ItemCode+' onclick="OpenClinicInfoDetailExam(this.id);">详细</a></td></tr>';
			  
						  $("#table-column-toggle-tbody").append(trcontent);
					  }
					  
					  else if(Type=="LabTestInfo")
					  {
						  var LabItemTypeName=$(this).find("LabItemTypeName").text();
						  var LabItemName=$(this).find("LabItemName").text();
						  var LabTestDate=$(this).find("LabTestDate").text();
						  var Status=$(this).find("Status").text();
						  var ReportDate=$(this).find("ReportDate").text();
						  var SortNo=$(this).find("SortNo").text();
						  var LabItemCode=$(this).find("LabItemCode").text();
						  var trcontent="<tr><td>"+LabItemTypeName+"</td><td>"+LabItemName+"</td><td>"+LabTestDate+"</td><td>"+Status+"</td><td>"+ReportDate+"</td><td id='ClinicInfoDetailByType-LabTestInfo'><a id = "+localStorage.getItem('PatientId')+"|"+VisitId+"|"+SortNo+"|"+LabItemCode+' onclick="OpenClinicInfoDetailLab(this.id);">详细</a></td></tr>';

						  $("#table-column-toggle-tbody").append(trcontent);
					  }
					  else
					  {
						  alert("Wrong Type!");
					  }
						  
				  }); 
			  }
		  });
	  $("#table-column-toggle").table("refresh");
	  $( "#ClinicInfoDetail-form" ).trigger( "updatelayout" );
  }
  
  
  
  function OpenClinicInfoDetailExam(TypeId) {

	  var TypeId_split=TypeId.split("|",4);
	  var UserId = TypeId_split[0];
	  var VisitId = TypeId_split[1];
	  var SortNo = TypeId_split[2];
	  var ItemCode = TypeId_split[3];
	  
	  document.getElementById("table-ClinicInfoDetailByType-tbody").innerHTML="";
	  document.getElementById("table-ClinicInfoDetailByType-thead").innerHTML="<tr><td>参数编码名称</td><td>参数值</td><td>单位</td><td>是否正常</td></tr>";
	  
	  
	  $.ajax({
		  url:  'http://'+serverIP+'/'+serviceName+'/GetExamDtlList',
		  type: "GET",
		  dataType: "xml",
		  async: false,
		  data: { UserId: UserId, VisitId: VisitId, SortNo: SortNo, ItemCode: ItemCode },
		  success: function (res) {
			  
			  $(res).find('Table1').each(function() {
					  
				  var Name=$(this).find("Name").text();
				  var Value=$(this).find("Value").text();
				  var Unit=$(this).find("Unit").text();
				  var IsAbnormal=$(this).find("IsAbnormal").text();
					  
				  var trcontent="<tr><td>"+Name+"</td><td>"+Value+"</td><td>"+Unit+"</td><td>"+IsAbnormal+"</td></tr>";

				  $("#table-ClinicInfoDetailByType-tbody").append(trcontent);
					  
			  }); 
		  }
	  });
	  $("#table-ClinicInfoDetailByType").table("refresh");
	  $( "#ClinicInfoDetail-form" ).trigger( "updatelayout" );
  }
  
  function OpenClinicInfoDetailLab(TypeId) {

	  var TypeId_split=TypeId.split("|",4);
	  var UserId = TypeId_split[0];
	  var VisitId = TypeId_split[1];
	  var SortNo = TypeId_split[2];
	  var ItemCode = TypeId_split[3];
	  
	  document.getElementById("table-ClinicInfoDetailByType-tbody").innerHTML="";
	  document.getElementById("table-ClinicInfoDetailByType-thead").innerHTML="<tr><td>参数名称</td><td>参数值</td><td>单位</td><td>是否正常</td></tr>";
	  
	  
	  $.ajax({
		  url:  'http://'+serverIP+'/'+serviceName+'/GetLabTestDtlList',
		  type: "GET",
		  dataType: "xml",
		  async: false,
		  data: { UserId: UserId, VisitId: VisitId, SortNo: SortNo, ItemCode: ItemCode },
		  success: function (res) {
			  
				  $(res).find('Table1').each(function() {
					  
						  var Name=$(this).find("Name").text();
						  var Value=$(this).find("Value").text();
						  var Unit=$(this).find("Unit").text();
						  var IsAbnormal=$(this).find("IsAbnormal").text();
					  
						  var trcontent="<tr><td>"+Name+"</td><td>"+Value+"</td><td>"+Unit+"</td><td>"+IsAbnormal+"</td></tr>";

					  
						  $("#table-ClinicInfoDetailByType-tbody").append(trcontent);
				  }); 
			  }
		  });
	  $("#table-ClinicInfoDetailByType").table("refresh");
	  $( "#ClinicInfoDetail-form" ).trigger( "updatelayout" );
  }
  
  //获取当前血压与目标血压之间的差值
  function getGoalValue(){
	  $.ajax({  
		type: "POST",
		dataType: "xml",
		timeout: 30000,  
		url: 'http://'+ serverIP +'/'+serviceName+'/GetGoalValue',
		async:false,
		data: {PlanNo:localStorage.getItem('NewPlanNo')},
		success: function(result) {  
			target = parseInt($(result).text());
			toTarget = target;
			target = target - lifeChanges - drugChanges;
			if(target < 0){
			    target = 0;	
			}
			$("#goal").text(target + 'mmHg');
		}, 
		error: function(msg) {alert("Error! loadLifeStyle");}
	  });
  }
  
  //加载生活方式列表
  function loadLifeStyle(){
	  var sid = "";
	  var strs = "";
	  var changes = "";
	  var effect = 0;
	  $.ajax({  
		type: "POST",
		dataType: "xml",
		timeout: 30000,  
		url: 'http://'+ serverIP +'/'+serviceName+'/GetLifeStyleDetail',
		async:false,
		data: {Module:localStorage.getItem('ModuleType')},
		success: function(result) {  
			$(result).find('Table1').each(function(){		
			  sid = $(this).find("StyleId").text();
			  changes = $(this).find("CurativeEffect").text();
			  strs += '<tr><td><div class="checkboxRound"><input type="checkbox" name="LifeStyle" id="' 
				+ sid + '" value="' + sid + '" data-role="none" onclick="setLifeChanges(this, ' 
				+ changes +')"><label for="' + sid + '"></label></div></td><td>' 
				+ $(this).find("Name").text() + '</td><td>' 
				+ $(this).find("Instruction").text() + '</td><td>' 
				+ changes + $(this).find("Unit").text() + '</td><td>' 
				+ $(this).find("SideEffect").text() + '</td></tr>';
			  	
		    });
			$("#LifeStyleBody").empty();
			$("#LifeStyleBody").append(strs);  		
		}, 
		error: function(msg) {alert("Error! loadLifeStyle");}
	  });
  }
  
  //加载“上一次”或“暂存”计划的生活方式
  function loadLastLifeStyle(){
	  if(localStorage.getItem('PLType') ==1 || localStorage.getItem('PLType') == 4){
		  $.ajax({  
			  type: "POST",
			  dataType: "xml",
			  timeout: 30000,  
			  url: 'http://'+ serverIP +'/'+serviceName+'/GetPsTaskByType',
			  async:false,
			  data: {PlanNo:localStorage.getItem('PlanNo'), Type:"LifeStyle"},
			  success: function(result) {  
				  $(result).find('Table1').each(function(){		
					sid = $(this).find("Code").text();
					$("input:checkbox[id='" + sid +"']").attr('checked', 'true');
				});		
			  }, 
			  error: function(msg) {alert("Error! loadLifeStyle");}
		  });
		  
		  $("input[name='LifeStyle']:checked").each(function () {
			  effect = parseInt($(this).parent().parent().next().next().next().text());
		      lifeChanges += effect;
		      (target - effect) > 0? target -= effect: target = 0;
		  });
		  
		  $("#lifestyleChanges").text(lifeChanges + 'mmHg');
	      $("#goal").text(target + 'mmHg');
		  
	  }
  }
  
  //加载以往的“药物治疗”记录
  function loadDrugList(){
	  var plType = localStorage.getItem('PLType');
	  var strdl = "";
	  if(plType == 1 || plType == 4)
	  {
		  $.ajax({  
			  type: "POST",
			  dataType: "xml",
			  timeout: 30000,  
			  url: 'http://'+ serverIP +'/'+serviceName+'/GetPsTaskByType',
			  async:false,
			  data: {PlanNo:localStorage.getItem('PlanNo'), Type:"Drug"},
			  success: function(result) {  
			      if($(result).find('Table1').length > 0){
					  if(plType == 4){
						  strdl += '<h4>△上次计划中使用的药品：';
					  }
					  else if(plType == 1){
						  strdl += '<h4>△本次计划中原计划使用的药品：';
					  }
			          $(result).find('Table1').each(function(){		
					      strdl += $(this).find("CodeName").text() + '（' + $(this).find("Instruction").text() + '）；';
				      });
					  strdl = strdl.substr(0, strdl.length - 1);
					  strdl += '</h4>';
					  $("#LastDrugListDiv").empty();
	                  $("#LastDrugListDiv").append(strdl);
				  }
			  }, 
			  error: function(msg) {alert("Error! loadDrugList");}
		  });
		  
	  }
  }
  
  //获得患者的药嘱记录
  function getPatientDrugRecord(){
	  var strdr = "";
	  var content = "";
	  var drugId = "";
	  var otherDetail = "";
	  var divsty;
	  $.ajax({  
		type: "POST",
		dataType: "xml",
		timeout: 30000,  
		url: 'http://'+ serverIP +'/'+serviceName+'/GetPatientDrugRecord',
		async:false,
		data: {PatientId:localStorage.getItem('PatientId'),Module:localStorage.getItem('ModuleType')},
		success: function(result) {  
			if($(result).find('Table1').length > 0){
				strdr += '<fieldset data-role="controlgroup">';
	
				$(result).find('Table1').each(function(){
					content = $(this).find("DrugName").text() + '—' + $(this).find("Administration").text() 
						+ '—' + $(this).find("Frequency").text() + '，1次' + $(this).find("Dosage").text() + $(this).find("DosageUnits").text();
					drugId = $(this).find("VisitId").text() + '#' + $(this).find("OrderNo").text() + '#' + $(this).find("OrderSubNo").text();
					otherDetail = $(this).find("OrderCode").text()
						+ '#' + $(this).find("CurativeEffect").text() + '#' + $(this).find("SideEffect").text() 
						+ '#' + $(this).find("Instruction").text() + '#' + $(this).find("Unit").text();
					
					strdr += '<input type="checkbox" name="drugrecord" id="' + drugId + '" value="' + otherDetail +'">'
						+'<label for="' + drugId +'">' + content + '</label>';  	
				});
				strdr += '</fieldset>';
				divsty = {height:'250px',width:'400px',overflow:'auto'};
				$("#popupDrugDiv").css(divsty);
				$("#popupDrugDiv").empty();
				$("#popupDrugDiv").append(strdr); 
				$("#popupDrugDiv").trigger("create");	
			}
			else{
				$("#drugBtn").css("visibility", "hidden");
				$("#drugTitle").text("药物治疗：该患者暂无药嘱");
			}
		}, 
		error: function(msg) {alert("Error! getPatientDrugRecord");}
	  });
  }
  
  //选择药嘱，生成药物治疗列表
  function setPsDrug(){
	  var druginfo = "";
	  var druginfo2 = "";
	  var strpd = "";
	  var drugeffect = 0;
	  strpd += '<thead><tr><th></th><th>用法</th><th>频次及用量</th><th>说明</th><th>效果</th><th>副作用</th></tr></thead><tbody id="DrugListBody">';
	  $("input[name='drugrecord']:checked").each(function () {
		  druginfo = this.value.toString().split('#');
		  druginfo2 = $(this).siblings(0).text().split('—');
		  strpd += '<tr><td style="display:none;">' + druginfo[0] + '</td><td>' 
		  		  + druginfo2[0] +'</td><td>'
				  + druginfo2[1] + '</td><td>'
		          + druginfo2[2] + '</td><td>' 
				  + druginfo[3] + '</td><td>' 
				  + druginfo[1] + druginfo[4] + '</td><td>' 
				  + druginfo[2] + '</td></tr>';
		  drugeffect += parseInt(druginfo[1] != ""? druginfo[1]: "0");	    	
	  });
	  
	  strpd += '</tbody>';
	  $("#DrugListTable").empty();
	  $("#DrugListTable").append(strpd);
	  
	  drugChanges = 0;
	  if(lifeChanges < toTarget){
		  target = toTarget - lifeChanges;
	  }
	  
	  if(target - drugeffect > 0){
		  drugChanges = drugeffect;
		  target -= drugeffect;
	  }
	  else{
		  drugChanges = drugeffect;
		  target = 0;
	  }
	  $("#drugChanges").text(drugChanges + 'mmHg');
	  $("#goal").text(target + 'mmHg');
  }  
  
  //生活方式对血压的影响
  function setLifeChanges(cb, effect){
	  var status = cb.checked;
	  if(status){
		  lifeChanges += effect;
		  (target - effect) > 0? target -= effect: target = 0;
	  }
	  else{
		  if(lifeChanges > toTarget && lifeChanges + drugChanges - effect < toTarget){
		      target += toTarget - (lifeChanges + drugChanges - effect);		
		  }
		  else if(lifeChanges <= toTarget && target === 0){
		      target = (drugChanges >= toTarget)? 0: (toTarget - drugChanges - lifeChanges + effect);
			  target = target >=0? target: 0;
		  }
		  else if(lifeChanges <= toTarget && target !== 0){
		      target = target + effect; 
		  }
		  
		  lifeChanges -= effect; 
	  }
	  $("#lifestyleChanges").text(lifeChanges + 'mmHg');
	  $("#goal").text(target + 'mmHg');
  };
  
  //药物治疗对血压的影响
  function setDrugChanges(cb, effect){
	  var status = cb.checked;
	  if(status){
		  if(target == 0){
			  cb.checked =! cb.checked;
			  alert("已超过目标，请调整计划！");
		  }
		  else if(target - effect > 0){
		      drugChanges += effect;
			  target -= effect;
		  }
		  else{
			  drugChanges += target;
			  target = 0;
			  //alert("已超过目标，请调整计划！");
		  }
	  }
	  else{
		  if(drugChanges - effect > 0){
		      drugChanges -= effect;
		  	  target += effect;
		  }
		  else{
			  target += drugChanges;
			  drugChanges = 0;
		  }
	  }
	  $("#drugChanges").text(drugChanges + 'mmHg');
	  $("#goal").text(target + 'mmHg');

  };
  
  //创建计划，插入Ps.Task
  function setPsTask(){
	var task_str = "";
	task_str += 'VitalSign#Bloodpressure|Bloodpressure_1#@' + 'VitalSign#Bloodpressure|Bloodpressure_2#@';
	$("input[name='LifeStyle']:checked").each(function () {
		task_str = task_str + this.name.toString() + '#' + this.value.toString() + '#@'; 
	});
	
	
	//$("input[name='Drug']:checked").each(function () {
	//	task_str = task_str + this.name.toString() + '#' + this.value.toString() + '@'; 
	//});
	if($("#DrugListTable").find("tbody"))
	{
		for(var i = 0; i < $("#DrugListTable").find("tbody").find("tr").length; i++){
			task_str = task_str + 'Drug#' + trim($("#DrugListBody tr:eq(" + i + ") td:eq(0)").text()) + '#' 
				+ trim($("#DrugListBody tr:eq(" + i + ") td:eq(2)").text()) + '，' + trim($("#DrugListBody tr:eq(" + i + ") td:eq(3)").text()) + '@';		
		}
	}
	
	if(task_str != ""){
		task_str = task_str.substring(0,task_str.length-1);	
	}
	
	if(task_str != ""){
		$.ajax({
			type: "POST",
			dataType: "xml",
			timeout: 30000,  
			url: 'http://'+ serverIP +'/'+serviceName+'/CreateTask',
			async:false,
			data: {PlanNo: localStorage.getItem('NewPlanNo'),
				   Task: task_str,
				   UserId: localStorage.getItem('UserId'),
				   TerminalName: localStorage.getItem('TerminalName'),
				   TerminalIP: localStorage.getItem('TerminalIP'),
				   DeviceType: localStorage.getItem('DeviceType')
				   },
			success: function(result) { 
				 if($(result).text()){
					 $.mobile.changePage("#StartPlanPage");
				 }  
				 else{
					 alert("任务创建失败");
				 }
			},
			error: function(msg) {alert("Error! setPsTask");}
		});
	}
	else{alert("请选择任务")};
  }  
  
  //令计划被激活或暂存
  function SetPlan(PlanNo, PatientId, StartDate, EndDate, Module, Status, DoctorId, piUserId, piTerminalName, piTerminalIP, piDeviceType){
	  $.ajax({  
		  type: "POST",
		  dataType: "xml",
		  timeout: 30000,  
		  url: 'http://'+ serverIP +'/'+serviceName+'/SetPlan',
		  async:false,
		  data: {PlanNo:PlanNo,
				 PatientId:PatientId,
				 StartDate:StartDate,
				 EndDate:EndDate,
				 Module:Module,
				 Status:Status,
				 DoctorId:DoctorId,
				 piUserId:piUserId,
				 piTerminalName:piTerminalName,
				 piTerminalIP:piTerminalIP,
				 piDeviceType:piDeviceType},
		  beforeSend: function(){},
		  success: function(result) {
			  var ret =  $(result).text();
			  if(ret == 1)
			  {   
				  if(Status == 3)
				  {
					  //alert("Plan " + PlanNo + " starts");
		alert("新建计划： " + PlanNo + " 成功！");

					  location.href = "HomePage.html?";	//ZAM 2015-5-4
				  }
				  else
				  {
					  alert("Back to edit plan "+ PlanNo);
				  }
			  }
			  else
			  {		
				  alert("失败");
			  }				    
		 }, 
		 error: function(msg) {alert("Error!");}
     });	
  }
  
  //得到任务清单
  function GetPsTask(PlanNo){
		$.ajax({  
        type: "POST",
        dataType: "xml",
		timeout: 30000,  
		url: 'http://'+ serverIP +'/'+serviceName+'/GetPsTask',
		//url: 'http://localhost:58895/Services.asmx/GetPsTask',
		async:false,
        data: {PlanNo:PlanNo},
		beforeSend: function(){},
        success: function(result) {
			var ret =  $.trim($(result).text()).replace(/ /g,"").split("\n\n\n");
			if(ret != "")
			{   
				for(j = 0; j < ret.length; j++){
				    if(ret[j].split("\n")[0] == ""){
						ret[j] = ret[j].replace("\n","");
					}
					var res = ret[j].split("\n");
					if(res[1]=="LifeStyle"){
						res[1] = "生活方式";
					}
					if(res[1]=="VitalSign"){
					    res[1] = "体征测量";
					}
					if(res[1]=="Drug"){
					    res[1] = "药物治疗";
					}
					if(res[4] == null){
						res[4] = "";
					}
					Tasklist[j] = res[0];
					if(j == 0){
						$("#L" + j).next().remove();
						$("#L" + j).after('<tbody><tr id="L' + (j+1) + '"><td><div align="center" style="width:80px;word-wrap:break-word;">' + res[0] + '</div></td><td><div align="center" style="width:80px;word-wrap:break-word;">' + res[1] + '</div></td><td><div align="center" style="width:80px;word-wrap:break-word;">' + res[3] + '</div></td><td><div style="width:185px;word-wrap:break-word;">' + res[4] + '</div></td></tr>');
					}
					else{
						$("#L" + j).after('<tr id="L' + (j+1) + '"><td><div align="center" style="width:80px;word-wrap:break-word;">' + res[0] + '</div></td><td><div align="center" style="width:80px;word-wrap:break-word;">' + res[1] + '</div></td><td><div align="center" style="width:80px;word-wrap:break-word;">' + res[3] + '</div></td><td><div style="width:185px;word-wrap:break-word;">' + res[4] + '</div></td></tr>');
					}
				}
				$("#L" + (j-1)).after('</tbody>');
			}
			else
			{		
			  	alert("该计划还没有布置任务");
			}				    
       }, 
       error: function(msg) {alert("Error!");}
     });	
  }
  
  //得到计划的目标
  function GetPsTarget(PlanNo){
	  $.ajax({  
	      type: "POST",
		  dataType: "xml",
		  timeout: 30000,  
		  url: 'http://'+ serverIP +'/'+serviceName+'/GetPsTarget',
		  async:false,
		  data: {PlanNo:PlanNo},
		  beforeSend: function(){},
		  success: function(result) {
			  var ret =  $.trim($(result).text()).replace(/ /g,"").split("\n\n\n");
			  if(ret != "")
			  {  
				  for(j = 0; j < ret.length; j++){
				  	  if(ret[j].split("\n")[0] == ""){
						ret[j] = ret[j].replace("\n","");
					  }
				  	  var res = ret[j].split("\n");
					  if(res[1] == "Bloodpressure" && res[3] == "Bloodpressure_1"){
						  $("#OSBP").val(res[6]);
						  $("#TSBP").val(res[5]);
					  }
					  if(res[1] == "Bloodpressure" && res[3] == "Bloodpressure_2"){
						  $("#ODBP").val(res[6]);
						  $("#TDBP").val(res[5]);
					  }
				  }
			  }
			  else
			  {		
				  alert("该计划还没有目标");
		 	  }				    
		  }, 
	      error: function(msg) {alert("Error!");}
      });	
  }
	
  //得到计划信息
  function GetPlanInfo(PlanNo){
	  $.ajax({  
		  type: "POST",
		  dataType: "xml",
		  timeout: 30000,  
		  url: 'http://'+ serverIP +'/'+serviceName+'/GetPlanInfo',
		  async:false,
		  data: {PlanNo:PlanNo},
		  beforeSend: function(){},
		  success: function(result) {
			  var ret =  $.trim($(result).text()).split(/\s+/);
			  if(ret != "")
			  {  
				  PatientId = ret[1];
				  StartDate = ret[2];
				  Module = ret[4];
				  DoctorId = ret[6];
			  }
			  else
			  {		
				  alert("计划读取失败");
			  }				    
		  }, 
		  error: function(msg) {alert("Error!");}
	  });	
  }
  
  //LY 20150604
  function SetCompliance(PatientId, DDate, PlanNo, Compliance, revUserId, TerminalName, TerminalIP, DeviceType){
      $.ajax({  
		  type: "POST",
		  dataType: "xml",
		  timeout: 30000,  
		  url: 'http://'+ serverIP +'/'+serviceName+'/SetCompliance',
		  async:false,
		  data: {PatientId:PatientId,
				 DDate:DDate,
				 PlanNo:PlanNo,
				 Compliance:Compliance,
				 revUserId:revUserId,
				 TerminalName:TerminalName,
				 TerminalIP:TerminalIP,
				 DeviceType:DeviceType},
		  beforeSend: function(){},
		  success: function(result) {
			  var ret =  $(result).text();			    
		 }, 
		 error: function(msg) {alert("Error!");}
     });
  }
  
  //LY 20150604
  function SetComplianceDetail(PatientId, DDate, PlanNo, Id, Status, CoUserId, CoTerminalName, CoTerminalIP, CoDeviceType){
      var Parent = PatientId + "||" + DDate + "||" + PlanNo;
      $.ajax({  
		  type: "POST",
		  dataType: "xml",
		  timeout: 30000,  
		  url: 'http://'+ serverIP +'/'+serviceName+'/SetComplianceDetail',
		  async:false,
		  data: {Parent:Parent,
				 Id:Id,
				 Status:Status,
				 CoUserId:CoUserId,
				 CoTerminalName:CoTerminalName,
				 CoTerminalIP:CoTerminalIP,
				 CoDeviceType:CoDeviceType},
		  beforeSend: function(){},
		  success: function(result) {
			  var ret =  $(result).text();			    
		 }, 
		 error: function(msg) {alert("SetComplianceDetail Error!");}
     });
  }
  
  //按下"确认开始"后发生LY
  function btn1_listener_f()
  {
	  $.ajax({  
		  type: "POST",
		  dataType: "xml",
		  timeout: 30000,  
		  url: 'http://'+ serverIP +'/'+serviceName+'/GetServerTime',
		  async:false,
		  data: {},
		  beforeSend: function(){},
		  success: function(result) {
			  StartDate =  $(result).text().slice(0,10).replace(/-/g,"");		    
		  }, 
		  error: function(msg) {alert("Error!");}
	  });
	  var EndDate = $("#EndDate").val().replace(/-/g,"");
	  //GetPlanInfo(localStorage.getItem('NewPlanNo'));
	  if(EndDate == ""){
	  	  $("#Alert").html("请输入结束时间");
		  return;
	  }
	  if(EndDate < StartDate){
	  	  $("#Alert").html("结束日期不能早于开始日期");
		  return;
	  }
	  $("#Alert").html("");
	  SetCompliance(localStorage.getItem('PatientId'), StartDate, localStorage.getItem('NewPlanNo'), 0, localStorage.getItem('UserId'), localStorage.getItem('TerminalName'), localStorage.getItem('TerminalIP'), localStorage.getItem('DeviceType'));
	  for(q = 0; q < Tasklist.length; q++){
	      SetComplianceDetail(localStorage.getItem('PatientId'), StartDate, localStorage.getItem('NewPlanNo'), Tasklist[q], 0, localStorage.getItem('UserId'), localStorage.getItem('TerminalName'), localStorage.getItem('TerminalIP'), localStorage.getItem('DeviceType'));
	  }
	  SetPlan(localStorage.getItem('NewPlanNo'), localStorage.getItem('PatientId'), StartDate, EndDate, localStorage.getItem('ModuleType'), 3, localStorage.getItem('UserId'), localStorage.getItem('UserId'), localStorage.getItem('TerminalName'), localStorage.getItem('TerminalIP'), localStorage.getItem('DeviceType'));
  }
  function TestValue(value, minValue, maxValue)
  {
	  var ret = false;
	if(value != "" && (value>=minValue &&value<=maxValue))
	   ret = true;
	   return ret; 
  }
</script>
</html>
